{% extends 'social/base.html' %}

{% block active %}
    <li class="nav-item active">
        <a class="nav-link" id="navTimeline" href="{%  url "social:timeline" %}">Timeline<span class="sr-only">(current)</span></a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="navSearch" href="{%  url "social:search" %}">Search</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="navMyFriends" href=" {%  url "social:friends" %}">My friends</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="navLogout" href="{% url "social:logout_view" %}">Logout</a>
    </li>
{% endblock%}

{% block content %}
    <h1>Timeline</h1>
    <div class="card" style="margin-left: 20px; width: 40rem;">
        <div class="card-body" >
            <h5 class="card-title">Friend requests</h5>
            <div>
                {%  if friend_requests %}
                    <ul>
                        {%  for req in friend_requests %}
                            <li>
                                <div class="card-body">
                                    <h5>{{ req.remitente.usuario.first_name }}</h5>
                                    <a href="{% url "social:respond_request" req.pk 1 %}" class ="btn btn-success"> Accept </a>
                                    <a href="{% url "social:respond_request" req.pk 0 %}" class ="btn btn-danger"> Reject </a>
                                </div>
                            </li> <br>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No friend requests.</p>
                {% endif %}
            </div>
        </div>
    </div> <br> <br>
    <form action="" method="post">
        {% csrf_token %}
        {{ forms }}
        <input class="btn btn-info btn-sm" id="submitButton" type="submit" value="Submit">
    </form>

    {%  if shouts %}
        <ul>
            {%  for shout in shouts %}
                {% if shout.recipients.count == 2 %}
                    <li> <div class="card" style="width: 30rem;">
                        <div class="card-body">
                            <h5 class="card-title">{{ shout.author.usuario.first_name }} -> {{ shout.recipients.last.usuario.first_name }}</h5>
                            <div><p>{{ shout.text }}</p></div>
                            <div style="float:right" ><p> <strong> posted </strong> {{ shout.pub_date }}</p></div>
                        </div>
                    </div>
                    </li>
                {% else %}
                    <li> <div class="card" style="width: 30rem;">
                        <div class="card-body">
                            <h5 class="card-title">{{ shout.author.usuario.first_name }} -> everyone</h5>
                            <div><p>{{ shout.text }}</p></div>
                            <div style="float:right" ><p> <strong> posted </strong> {{ shout.pub_date }}</p></div>
                        </div>

                    </div>
                    </li>

                {% endif %}

                <!-- Button trigger modal -->
                <button class="btn btn-info btn-sm" data-toggle="modal" data-target="#Modal{{ forloop.counter }}">
                    Open Chat
                </button><br> <br>

                <!-- Modal -->
                <div class="modal fade" id="Modal{{ forloop.counter }}" tabindex="-1" role="dialog" aria-labelledby="ModalScrollableTitle" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">

                                <h5 class="modal-title" id="ModalScrollableTitle"> Chat </h5>

                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>

                            </div>

                            <form action="{% url "social:open_chat" shout.id %}" method="POST">
                                {% csrf_token %}
                                <div class="modal-body">
                                    {{ chat_form }}
                                    <br>
                                    <div style="float:right" >
                                        <input type="submit" class="btn btn-primary" value="Send">
                                    </div>
                                    <br><br><hr>
                                    <ul>
                                        {#                                            {%  for shout in shouts %}#}
                                        {#                                                {% if shout.recipients.count == 2 and friend in shout.recipients.all%}#}
                                        {#                                                    <li>#}
                                        {#                                                        {% if shout.author == shout.recipients.last %}#}
                                        {#                                                            <h5 class="card-title">{{ shout.author.usuario.first_name }} -> {{ shout.recipients.first.usuario.first_name }}</h5>#}
                                        {#                                                        {% else %}#}
                                        {#                                                            <h5 class="card-title">{{ shout.author.usuario.first_name }} -> {{ shout.recipients.last.usuario.first_name }}</h5>#}
                                        {#                                                        {% endif %}#}
                                        {#                                                        <div><p>{{ shout.text }}</p></div>#}
                                        {#                                                        <div style="float:right" ><p> <strong> posted </strong> {{ shout.pub_date }}</p></div>#}
                                        {#                                                    </li><br>#}
                                        {#                                                    <hr>#}
                                        {#                                                {% endif %}#}
                                        {#                                            {% endfor %}#}
                                    </ul>
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                </div>
                            </form>

                        </div>
                    </div>
                </div>
            {% endfor %}
        </ul>
    {% else %}
        <p>No posts available.<a href="{% url "social:search" %}"> Add friends</a> to see their posts here.</p>
    {% endif %}
{% endblock %}